<html lang="en">

<!-- Mirrored from mr.gy/ansi-common-lisp/flet_003b-labels_003b-macrolet.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 10 Sep 2021 20:36:28 GMT -->
<head>
<title>flet; labels; macrolet - ANSI Common Lisp</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="ANSI Common Lisp">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index-2.html#Top">
<link rel="up" href="Data-and-Control-Flow.html#Data-and-Control-Flow" title="Data and Control Flow">
<link rel="prev" href="fmakunbound.html#fmakunbound" title="fmakunbound">
<link rel="next" href="funcall.html#funcall" title="funcall">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
body {font-family: century schoolbook, serif;
      line-height: 1.3;
      padding-left: 5em; padding-right: 1em;
      padding-bottom: 1em; max-width: 60em;}
table {border-collapse: collapse}
span.roman { font-family: century schoolbook, serif; font-weight: normal; }
h1, h2, h3, h4, h5, h6 {font-family:  Helvetica, sans-serif}
dfn {font-family: inherit; font-variant: italic; font-weight: bolder }
kbd {font-family: monospace; text-decoration: underline}
var {font-family: Helvetica, sans-serif; font-variant: slanted}
td  {padding-right: 1em; padding-left: 1em}
sub {font-size: smaller}
.node {padding: 0; margin: 0}
--></style>
</head>
<body>
<div class="node">
<a name="flet%3b-labels%3b-macrolet"></a>
<a name="flet_003b-labels_003b-macrolet"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="funcall.html#funcall">funcall</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="fmakunbound.html#fmakunbound">fmakunbound</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Data-and-Control-Flow.html#Data-and-Control-Flow">Data and Control Flow</a>
<hr>
</div>

<h3 class="heading">flet, labels, macrolet (Special Operator)</h3>

<p><a name="index-flet-442"></a><a name="index-flet-443"></a><a name="index-labels-444"></a><a name="index-labels-445"></a><a name="index-macrolet-446"></a><a name="index-macrolet-447"></a><a name="flet"></a><a name="labels"></a><a name="macrolet"></a>

<h5 class="subsubheading">Syntax:</h5>

<div class="defun">
&mdash; Special Form: <b>flet</b> <tt>(</tt><tt>{</tt><tt>(</tt><var>function-name&nbsp;&nbsp;lambda-list&nbsp;〚</var><tt>{</tt><var>local-declaration</var><tt>}</tt><var>*&nbsp;</var><span class="roman">|</span><var>&nbsp;local-documentation〛&nbsp;</var><tt>{</tt><var>local-form</var><tt>}</tt><var>*</var><tt>)</tt><tt>}</tt><var>*</var><tt>)</tt><var><!-- /@w --> </var><tt>{</tt><var>declaration</var><tt>}</tt><var>*&nbsp;</var><tt>{</tt><var>form</var><tt>}</tt><var>*<!-- /@w --> </var><span class="roman">→</span> <tt>{</tt><var>result</var><tt>}</tt><var>*<a name="index-flet-448"></a></var><br>
     </div>

<div class="defun">
&mdash; Special Form: <b>labels</b> <tt>(</tt><tt>{</tt><tt>(</tt><var>function-name&nbsp;&nbsp;lambda-list&nbsp;〚</var><tt>{</tt><var>local-declaration</var><tt>}</tt><var>*&nbsp;</var><span class="roman">|</span><var>&nbsp;local-documentation〛&nbsp;</var><tt>{</tt><var>local-form</var><tt>}</tt><var>*</var><tt>)</tt><tt>}</tt><var>*</var><tt>)</tt><var><!-- /@w --> </var><tt>{</tt><var>declaration</var><tt>}</tt><var>*&nbsp;</var><tt>{</tt><var>form</var><tt>}</tt><var>*<!-- /@w --> </var><span class="roman">→</span> <tt>{</tt><var>result</var><tt>}</tt><var>*<a name="index-labels-449"></a></var><br>
     </div>

<div class="defun">
&mdash; Special Form: <b>macrolet</b> <tt>(</tt><tt>{</tt><tt>(</tt><var>name&nbsp;&nbsp;lambda-list&nbsp;〚</var><tt>{</tt><var>local-declaration</var><tt>}</tt><var>*&nbsp;</var><span class="roman">|</span><var>&nbsp;local-documentation〛&nbsp;</var><tt>{</tt><var>local-form</var><tt>}</tt><var>*</var><tt>)</tt><tt>}</tt><var>*</var><tt>)</tt><var><!-- /@w --> </var><tt>{</tt><var>declaration</var><tt>}</tt><var>*&nbsp;</var><tt>{</tt><var>form</var><tt>}</tt><var>*<!-- /@w --> </var><span class="roman">→</span> <tt>{</tt><var>result</var><tt>}</tt><var>*<a name="index-macrolet-450"></a></var><br>
     </div>

<h5 class="subsubheading">Arguments and Values:</h5>

<p><var>function-name</var>&mdash;a <i>function name</i>.

<p><var>name</var>&mdash;a <i>symbol</i>.

<p><var>lambda-list</var>&mdash;a <i>lambda list</i>;
for <code>flet</code> and <code>labels</code>,
it is an <i>ordinary lambda list</i>;
for <code>macrolet</code>,
it is a <i>macro lambda list</i>.

<p><var>local-declaration</var>&mdash;a <tt>declare</tt> <i>expression</i>; not evaluated.

<p><var>declaration</var>&mdash;a <tt>declare</tt> <i>expression</i>; not evaluated.

<p><var>local-documentation</var>&mdash;a <i>string</i>; not evaluated.

<p><var>local-forms</var>, <var>forms</var>&mdash;an <i>implicit progn</i>.

<p><var>results</var>&mdash;the <i>values</i> of the <var>forms</var>.

<h5 class="subsubheading">Description:</h5>

<p><code>flet</code>, <code>labels</code>, and <code>macrolet</code>
define local <i>functions</i> and <i>macros</i>, and execute
<var>forms</var> using the local definitions. 
<var>Forms</var> are executed  in order of occurrence.

<p>The body forms (but not the <i>lambda list</i>)
of each <i>function</i> created by <code>flet</code> and <code>labels</code>
and each <i>macro</i> created by <code>macrolet</code>
are enclosed in an <i>implicit block</i> whose name
is the <i>function block name</i> of the <var>function-name</var> or <var>name</var>,
as appropriate.

<p>The scope of the <var>declarations</var>
between
the list of local function/macro definitions and the body <var>forms</var>
in <code>flet</code> and <code>labels</code>
does not include the bodies of the
locally defined <i>functions</i>, except that for <code>labels</code>,
any <code>inline</code>, <code>notinline</code>, or <code>ftype</code> declarations
that refer to the locally defined functions do apply to the local function
bodies. That is, their <i>scope</i>
is the same as the function name that they
affect. 
The scope of these <var>declarations</var>
does not include the bodies of the macro expander
functions defined by <code>macrolet</code>.

     <dl>
<dt><b>flet</b><dd>

     <p><code>flet</code> defines locally named <i>functions</i> and executes a series of
<var>forms</var> with these definition <i>bindings</i>.  Any number of
such local <i>functions</i> can be defined.

     <p>The <i>scope</i> of the name <i>binding</i> encompasses only the body. 
Within the
body of <code>flet</code>,
<var>function-names</var> matching those defined
by <code>flet</code>
refer to the locally defined <i>functions</i>
rather than to
the global function definitions of the same name. 
Also, within the scope of <code>flet</code>,
global <i>setf expander</i> definitions of the <var>function-name</var>
defined by <code>flet</code> do not apply. 
Note that this applies to
<code>(defsetf </code><i>f</i><code> ...)</code>, not
<code>(defmethod (setf </code><i>f</i><code>) ...)</code>.

     <p>The names of <i>functions</i> defined by <code>flet</code>
are in the <i>lexical environment</i>; they retain
their local definitions only within the body of <code>flet</code>. 
The function definition bindings are visible only in
the body of <code>flet</code>, not the definitions themselves.  Within the
function definitions, local function names
that match those being
defined refer to <i>functions</i> or
<i>macros</i> defined outside the <code>flet</code>. 
<code>flet</code> can locally <i>shadow</i> a global function name,
and the new definition can refer to the global definition.

     <p>Any <var>local-documentation</var> is attached to the corresponding local <var>function</var>
(if one is actually created) as a <i>documentation string</i>.

     <br><dt><b>labels</b><dd>

     <p><code>labels</code> is equivalent to <code>flet</code> except that
the scope of the defined function names for <code>labels</code>
encompasses the function definitions themselves as well as the body.

     <br><dt><b>macrolet</b><dd>

     <p><code>macrolet</code>
establishes local <i>macro</i> definitions,
using the same format used by <code>defmacro</code>.

     <p>Within the body of <code>macrolet</code>,
global <i>setf expander</i> definitions of the <var>names</var> defined by the
<code>macrolet</code> do not apply; rather, <code>setf</code> expands the
<i>macro form</i> and recursively process the resulting <i>form</i>.

     <p>The macro-expansion functions defined by <code>macrolet</code>
are defined in the
<i>lexical environment</i> in which the <code>macrolet</code> form appears. 
Declarations and <code>macrolet</code> and
<code>symbol-macrolet</code> definitions
affect the local macro definitions in a <code>macrolet</code>, but the
consequences are undefined if the local macro definitions reference
any local <i>variable</i> or <i>function</i> <i>bindings</i> that are visible in that
<i>lexical environment</i>.

     <p>Any <var>local-documentation</var> is attached to the corresponding local <var>macro function</var>
as a <i>documentation string</i>. 
</dl>

<h5 class="subsubheading">Examples:</h5>

<pre class="lisp"> (defun foo (x flag)
   (macrolet ((fudge (z)
                 ;The parameters x and flag are not accessible
                 ; at this point; a reference to flag would be to
                 ; the global variable of that name.
                 `&nbsp;<!-- /@w -->(if flag (* ,z ,z) ,z)))
    ;The parameters x and flag are accessible here.
     (+ x
        (fudge x)
        (fudge (+ x 1)))))
 ≡
 (defun foo (x flag)
   (+ x
      (if flag (* x x) x)
      (if flag (* (+ x 1) (+ x 1)) (+ x 1))))
</pre>
<p>after macro expansion.  The occurrences of <code>x</code> and <code>flag</code> legitimately
refer to the parameters of the function <code>foo</code> because those parameters are
visible at the site of the macro call which produced the expansion.

<pre class="lisp"> (flet ((flet1 (n) (+ n n)))
    (flet ((flet1 (n) (+ 2 (flet1 n))))
      (flet1 2))) <span class="roman">→</span> 6

 (defun dummy-function () 'top-level) <span class="roman">→</span> DUMMY-FUNCTION
 (funcall #'dummy-function) <span class="roman">→</span> TOP-LEVEL
 (flet ((dummy-function () 'shadow))
      (funcall #'dummy-function)) <span class="roman">→</span> SHADOW
 (eq (funcall #'dummy-function) (funcall 'dummy-function))
<span class="roman">→</span> <i>true</i>
 (flet ((dummy-function () 'shadow))
   (eq (funcall #'dummy-function)
       (funcall 'dummy-function)))
<span class="roman">→</span> <i>false</i>

 (defun recursive-times (k n)
   (labels ((temp (n)
              (if (zerop n) 0 (+ k (temp (1- n))))))
     (temp n))) <span class="roman">→</span> RECURSIVE-TIMES
 (recursive-times 2 3) <span class="roman">→</span> 6

 (defmacro mlets (x &amp;environment env)
    (let ((form `(babbit ,x)))
      (macroexpand form env))) <span class="roman">→</span> MLETS
 (macrolet ((babbit (z) `(+ ,z ,z))) (mlets 5)) <span class="roman">→</span> 10
</pre>
<pre class="lisp"> (flet ((safesqrt (x) (sqrt (abs x))))
  ;; The safesqrt function is used in two places.
   (safesqrt (apply #'+ (map 'list #'safesqrt '(1 2 3 4 5 6)))))
<span class="roman">→</span> 3.291173
</pre>
<pre class="lisp"> (defun integer-power (n k)
   (declare (integer n))
   (declare (type (integer 0 *) k))
   (labels ((expt0 (x k a)
              (declare (integer x a) (type (integer 0 *) k))
              (cond ((zerop k) a)
                    ((evenp k) (expt1 (* x x) (floor k 2) a))
                    (t (expt0 (* x x) (floor k 2) (* x a)))))
            (expt1 (x k a)
              (declare (integer x a) (type (integer 0 *) k))
              (cond ((evenp k) (expt1 (* x x) (floor k 2) a))
                    (t (expt0 (* x x) (floor k 2) (* x a))))))
    (expt0 n k 1))) <span class="roman">→</span> INTEGER-POWER
</pre>
<pre class="lisp"> (defun example (y l)
   (flet ((attach (x)
            (setq l (append l (list x)))))
     (declare (inline attach))
     (dolist (x y)
       (unless (null (cdr x))
         (attach x)))
     l))

 (example '((a apple apricot) (b banana) (c cherry) (d) (e))
          '((1) (2) (3) (4 2) (5) (6 3 2)))
<span class="roman">→</span> ((1) (2) (3) (4 2) (5) (6 3 2) (A APPLE APRICOT) (B BANANA) (C CHERRY))
</pre>
<h5 class="subsubheading">See Also:</h5>

<p><a href="declare.html#declare">declare</a>,
<a href="defmacro.html#defmacro">defmacro</a>,
<a href="defun.html#defun">defun</a>,
<a href="documentation.html#documentation">documentation</a>,
<a href="let.html#let">let</a>,
<a href="Evaluation.html#Evaluation">Section 3.1 (Evaluation)</a>,
<a href="Syntactic-Interaction-of-Documentation-Strings-and-Declarations.html#Syntactic-Interaction-of-Documentation-Strings-and-Declarations">Section 3.4.11 (Syntactic Interaction of Documentation Strings and Declarations)</a>

<h5 class="subsubheading">Notes:</h5>

<p>It is not possible to define recursive <i>functions</i> with <code>flet</code>. 
<code>labels</code> can be used to define mutually recursive <i>functions</i>.

<p>If a <code>macrolet</code> <i>form</i> is a <i>top level form</i>,
the body <var>forms</var> are also processed as <i>top level forms</i>. 
See <a href="File-Compilation.html#File-Compilation">Section 3.2.3 (File Compilation)</a>.

</body>
<!-- Mirrored from mr.gy/ansi-common-lisp/flet_003b-labels_003b-macrolet.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 10 Sep 2021 20:36:29 GMT -->
</html>

